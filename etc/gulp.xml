<?xml version="1.0" encoding="UTF-8" ?>
<gulp
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="urn:magento:module:MaxBucknell_Gulp:etc/gulp.xsd"
>
    <task name="env">
        <command>env</command>
    </task>

    <task name="flatten:static">
        <dependencies>
            <package name="lodash" version="latest" />
            <package name="glob" version="latest" />
            <package name="mkdirp" version="latest" />
        </dependencies>

        <command>node MaxBucknell_Gulp/task/flatten/static.js</command>
    </task>

    <task name="flatten:templates">
        <dependencies>
            <package name="lodash" version="latest" />
            <package name="glob" version="latest" />
            <package name="mkdirp" version="latest" />
        </dependencies>

        <command>node MaxBucknell_Gulp/task/flatten/templates.js</command>
    </task>

    <task name="flatten:requirejs-config">
        <dependencies>
            <package name="lodash" version="latest" />
            <package name="glob" version="latest" />
            <package name="mkdirp" version="latest" />
        </dependencies>

        <command>node MaxBucknell_Gulp/task/flatten/requirejs-config.js</command>
    </task>

    <task name="flatten">
        <dependencies>
            <package name="concurrently" version="latest" />
        </dependencies>

        <command>concurrently "npm run flatten:static" "npm run flatten:templates" "npm run flatten:requirejs-config"</command>
    </task>

    <task name="clean:build">
        <dependencies>
            <package name="rimraf" version="latest" />
        </dependencies>

        <command>node MaxBucknell_Gulp/task/clean/build.js</command>
    </task>

    <task name="clean:pub">
        <dependencies>
            <package name="rimraf" version="latest" />
        </dependencies>

        <command>node MaxBucknell_Gulp/task/clean/pub.js</command>
    </task>

    <task name="clean">
        <command>concurrently "npm run clean:build" "npm run clean:pub"</command>
    </task>

    <task name="less">
        <dependencies>
            <package name="less" version="latest" />
            <package name="spawn-command" version="latest" />
            <package name="concurrently" version="latest" />
        </dependencies>
        <command>node MaxBucknell_Gulp/task/less.js 'lessc --source-map-map-inline --plugin=./MaxBucknell_Gulp/less/magento-import.js {{input}} > {{output}}'</command>
    </task>

    <task name="css">
        <command>concurrently "npm run less"</command>
    </task>

    <task name="postcss">
        <dependencies>
            <package name="postcss-cli" version="latest" />
            <package name="cssnano" version="latest" />
            <package name="autoprefixer" version="latest" />
        </dependencies>
        <command>node MaxBucknell_Gulp/task/postcss.js</command>
    </task>

    <task name="copy">
        <dependencies>
            <package name="cpx" version="latest" />
        </dependencies>
        <command>cpx "$BUILD_DIR"'/flat/static/**/*.{css,csv,eot,gif,htc,htm,html,ico,jbf,jpeg,jpg,js,json,less,map,md,png,sass,scss,svg,swf,ttf,txt,woff,woff2}' "$OUTPUT_DIR" --dereference</command>
    </task>

    <task name="requirejs-config">
        <dependencies>
            <package name="glob" version="latest" />
        </dependencies>
        <command>mkdir -p "$REQUIREJS_CONFIG_DIR" &amp;&amp; node MaxBucknell_Gulp/task/requirejs-config.js &gt; "$REQUIREJS_CONFIG_DIR/requirejs-config.js"</command>
    </task>

    <task name="babel">
        <dependencies>
            <package name="babel-cli" version="latest" />
            <package name="babel-preset-env" version="latest" />
        </dependencies>
        <command>babel "$BUILD_DIR/flat/static" --out-dir "$OUTPUT_DIR" --extensions ".es"</command>
    </task>

    <task name="js">
        <command>concurrently "npm run babel"</command>
    </task>

    <task name="build">
        <command>concurrently "npm run copy" "npm run css" "npm run requirejs-config" "npm run js"</command>
    </task>
</gulp>